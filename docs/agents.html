<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agents | Phantom Paradox</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23111' width='100' height='100' rx='8'/><text x='50' y='62' font-family='monospace' font-size='24' fill='%2300ff88' text-anchor='middle' font-weight='bold'>402</text></svg>">
  <!-- D3.js + TopoJSON for real world map -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0a0c0f;
      --card: #111418;
      --card-alt: #161a1f;
      --border: #22272e;
      --text: #e6e8eb;
      --dim: #6e7681;
      --green: #3fb950;
      --red: #f85149;
      --blue: #58a6ff;
      --orange: #d29922;
      --purple: #a371f7;
      --cyan: #39c5cf;
    }
    body {
      font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Consolas, monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 13px;
    }
    a { color: var(--cyan); text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    /* Header */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      font-size: 18px;
      font-weight: bold;
      color: var(--green);
    }
    .badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      background: var(--green);
      color: #000;
    }
    .header-right a {
      color: var(--dim);
      margin-left: 16px;
      font-size: 12px;
    }
    .header-right a:hover { color: var(--text); text-decoration: none; }
    
    /* Tabs */
    .tabs {
      display: flex;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .tab {
      padding: 12px 24px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      color: var(--dim);
      border-bottom: 3px solid transparent;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--green); border-bottom-color: var(--green); }
    
    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 1fr 320px;
      min-height: calc(100vh - 100px);
    }
    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
    
    /* Map Container */
    .map-container {
      background: var(--card);
      border-right: 1px solid var(--border);
      position: relative;
      min-height: 500px;
    }
    .map-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .map-title {
      font-size: 14px;
      font-weight: bold;
    }
    .map-stats {
      display: flex;
      gap: 20px;
      font-size: 12px;
    }
    .map-stat-value { color: var(--green); font-weight: bold; }
    
    /* World Map SVG */
    .world-map {
      width: 100%;
      height: calc(100% - 50px);
      position: relative;
      overflow: hidden;
    }
    #mapSvg {
      width: 100%;
      height: 100%;
    }
    #mapSvg path {
      fill: var(--card-alt);
      stroke: var(--border);
      stroke-width: 0.5;
    }
    
    /* Agent Markers */
    .agent-markers {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .marker {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      transform: translate(-50%, -50%);
      pointer-events: auto;
      cursor: pointer;
    }
    .marker::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 1px solid var(--green);
      opacity: 0.5;
      animation: ping 2s infinite;
    }
    @keyframes ping {
      75%, 100% { transform: scale(2); opacity: 0; }
    }
    .marker.you {
      width: 12px;
      height: 12px;
      background: var(--cyan);
      border: 2px solid #fff;
      z-index: 100;
    }
    .marker.you::after { border-color: var(--cyan); }
    .marker.cap-1 { background: var(--green); }
    .marker.cap-2 { background: var(--cyan); }
    .marker.cap-3 { background: var(--blue); }
    .marker.cap-4 { background: var(--purple); }
    .marker.cap-5 { background: var(--orange); }
    
    /* Legend */
    .map-legend {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 4px;
      font-size: 10px;
    }
    .legend-title {
      color: var(--dim);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }
    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    /* Sidebar */
    .sidebar {
      background: var(--card);
      display: flex;
      flex-direction: column;
    }
    .section {
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }
    .section-title {
      font-size: 10px;
      color: var(--dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: var(--dim); }
    .stat-value { font-weight: 500; }
    .stat-value.green { color: var(--green); }
    .stat-value.cyan { color: var(--cyan); }
    
    /* Agent List */
    .agent-list {
      flex: 1;
      overflow-y: auto;
      max-height: 300px;
    }
    .agent-item {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .agent-item:hover { background: var(--card-alt); }
    .agent-item.you { background: rgba(57, 197, 207, 0.1); border-left: 3px solid var(--cyan); }
    .agent-addr {
      font-size: 12px;
      color: var(--cyan);
      margin-bottom: 4px;
    }
    .agent-location {
      font-size: 10px;
      color: var(--dim);
    }
    .agent-metrics {
      display: flex;
      gap: 15px;
      margin-top: 6px;
      font-size: 10px;
    }
    .agent-metric span { color: var(--dim); }
    .agent-metric strong { color: var(--text); }
    .agent-metric strong.good { color: var(--green); }
    .agent-metric strong.warn { color: var(--orange); }
    
    /* Jobs */
    .job-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .job-item:last-child { border-bottom: none; }
    .job-name { display: flex; align-items: center; gap: 8px; }
    .job-rate { color: var(--green); font-weight: 500; }
    .job-unit { color: var(--dim); font-size: 10px; }
    
    /* Connect Button */
    .connect-btn {
      padding: 10px 20px;
      background: var(--green);
      border: none;
      color: #000;
      font-family: inherit;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
    }
    .connect-btn:hover { opacity: 0.9; }
    .connect-btn.connected { background: var(--cyan); }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--dim);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 15px; }
    .empty-state .msg { margin-bottom: 10px; }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Jobs Tab */
    .jobs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .job-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
    }
    .job-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .job-card-title {
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .job-card-rate {
      font-size: 16px;
      color: var(--green);
      font-weight: bold;
    }
    .job-card-desc {
      color: var(--dim);
      font-size: 12px;
      margin-bottom: 10px;
    }
    .job-card-tech {
      font-size: 10px;
      color: var(--purple);
      background: rgba(163, 113, 247, 0.1);
      padding: 4px 8px;
      border-radius: 3px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <span class="logo">AGENTS</span>
      <span class="badge" id="statusBadge">OFFLINE</span>
    </div>
    <div class="header-right">
      <a href="../index.html">‚Üê Paradox</a>
      <a href="sim.html">Live Sim</a>
      <button class="connect-btn" id="connectBtn">CONNECT WALLET</button>
    </div>
  </header>
  
  <div class="tabs">
    <div class="tab active" data-tab="map">üó∫Ô∏è Network Map</div>
    <div class="tab" data-tab="jobs">üíº Jobs</div>
    <div class="tab" data-tab="deploy">üì¶ Deploy</div>
  </div>
  
  <!-- MAP TAB -->
  <div class="tab-content active" id="tab-map">
    <div class="main">
      <div class="map-container">
        <div class="map-header">
          <span class="map-title">Global Agent Network</span>
          <div class="map-stats">
            <span><span class="map-stat-value" id="onlineCount">0</span> online</span>
            <span><span class="map-stat-value" id="regionCount">0</span> regions</span>
            <span><span class="map-stat-value" id="totalBw">0</span> Gbps</span>
          </div>
        </div>
        <div class="world-map">
          <svg id="mapSvg" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid slice"></svg>
          <div class="agent-markers" id="agentMarkers"></div>
        </div>
        <div class="map-legend">
          <div class="legend-title">Capability Level</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--green)"></div> Relay</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--cyan)"></div> + Compute</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--blue)"></div> + Verify</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--purple)"></div> + Jury</div>
          <div class="legend-item"><div class="legend-dot" style="background: var(--orange)"></div> Full Stack</div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="section">
          <div class="section-title">Your Agent</div>
          <div id="yourAgent">
            <div class="empty-state" style="padding: 20px;">
              <div style="font-size: 24px; margin-bottom: 10px;">üëÜ</div>
              <div>Click CONNECT WALLET</div>
              <div style="font-size: 10px;">to show your agent</div>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">Connected Agents</div>
          <div class="agent-list" id="agentList">
            <div class="empty-state" style="padding: 20px;">
              No agents online
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">You Earn (95% of job)</div>
          <div id="jobPricing">
            <div class="job-item"><span class="job-name">üîó Relay</span><span><span class="job-rate">$9.50</span><span class="job-unit">/GB</span></span></div>
            <div class="job-item"><span class="job-name">üì∏ Enhance</span><span><span class="job-rate">$0.047</span><span class="job-unit">/img</span></span></div>
            <div class="job-item"><span class="job-name">üé§ Transcribe</span><span><span class="job-rate">$0.057</span><span class="job-unit">/min</span></span></div>
            <div class="job-item"><span class="job-name">üéÆ GPU</span><span><span class="job-rate">$0.38</span><span class="job-unit">/hr</span></span></div>
            <div class="job-item"><span class="job-name">‚úì Verify</span><span><span class="job-rate">$0.019</span><span class="job-unit">/batch</span></span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- JOBS TAB -->
  <div class="tab-content" id="tab-jobs">
    <div style="padding: 15px 20px; background: var(--card); border-bottom: 1px solid var(--border);">
      <span style="color: var(--dim);">Customer pays listed price ‚Üí</span>
      <span style="color: var(--green); font-weight: bold;"> You earn 95%</span>
    </div>
    <div class="jobs-grid">
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üîó Residential Relay</span>
          <span class="job-card-rate">$10.00<span class="job-unit">/GB</span></span>
        </div>
        <div class="job-card-desc">Premium residential bandwidth for web scraping, market research.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$9.50/GB</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Mobile OK</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üì∏ Image Upscale</span>
          <span class="job-card-rate">$0.05<span class="job-unit">/img</span></span>
        </div>
        <div class="job-card-desc">AI 4x upscale. Used by e-commerce, photographers.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.047/img</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚úÇÔ∏è BG Remove</span>
          <span class="job-card-rate">$0.40<span class="job-unit">/img</span></span>
        </div>
        <div class="job-card-desc">Background removal. Used by e-commerce, designers.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.38/img</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üé§ Transcribe</span>
          <span class="job-card-rate">$0.06<span class="job-unit">/min</span></span>
        </div>
        <div class="job-card-desc">Speech-to-text. Used by podcasters, journalists.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.057/min</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üåê Translate</span>
          <span class="job-card-rate">$0.02<span class="job-unit">/1K chars</span></span>
        </div>
        <div class="job-card-desc">200+ languages. Used by businesses, content creators.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.019/1K</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üíª Desktop only</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üéÆ GPU Render</span>
          <span class="job-card-rate">$0.40<span class="job-unit">/hr</span></span>
        </div>
        <div class="job-card-desc">3D rendering, ML inference. Used by studios, AI companies.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.38/hr</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üéÆ GPU required</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚úì Batch Verify</span>
          <span class="job-card-rate">$0.02<span class="job-unit">/batch</span></span>
        </div>
        <div class="job-card-desc">Merkle proof verification for settlement batches.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.019/batch</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Any device</span></div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">‚öñÔ∏è Dispute Jury</span>
          <span class="job-card-rate">$0.50<span class="job-unit">/case</span></span>
        </div>
        <div class="job-card-desc">Vote on payment disputes. Requires PDOX stake.</div>
        <div style="margin-top: 8px; font-size: 11px;"><span style="color: var(--dim);">You earn:</span> <span style="color: var(--green);">$0.475/case</span></div>
        <div style="margin-top: 4px;"><span class="job-card-tech">üì± Any device</span></div>
      </div>
    </div>
  </div>
  
  <!-- DEPLOY TAB -->
  <div class="tab-content" id="tab-deploy">
    <div class="jobs-grid">
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üì± Mobile Agent</span>
          <span class="job-card-rate" style="color: var(--cyan);">PWA</span>
        </div>
        <div class="job-card-desc">Android/iOS. Relay only (battery limited).</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Bandwidth relay</div>
        <div style="font-size: 10px; color: var(--dim);">~1-3 GB/day realistic</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <span class="stat-value green">$0.10-0.30</span><span style="color: var(--dim)">/day max</span>
        </div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üåê Browser Extension</span>
          <span class="job-card-rate" style="color: var(--cyan);">Chrome/Firefox</span>
        </div>
        <div class="job-card-desc">Relay only. Runs while browsing.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Bandwidth relay</div>
        <div style="font-size: 10px; color: var(--dim);">~2-8 GB/day (8hr use)</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <span class="stat-value green">$0.20-0.80</span><span style="color: var(--dim)">/day max</span>
        </div>
      </div>
      <div class="job-card">
        <div class="job-card-header">
          <span class="job-card-title">üíª Desktop Agent</span>
          <span class="job-card-rate" style="color: var(--cyan);">Win/Mac/Linux</span>
        </div>
        <div class="job-card-desc">CPU compute + relay + verify.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Relay, CPU tasks, verify</div>
        <div style="font-size: 10px; color: var(--dim);">~5-20 GB + CPU tasks</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <span class="stat-value green">$0.50-2.00</span><span style="color: var(--dim)">/day max</span>
        </div>
      </div>
      <div class="job-card" style="border-color: var(--green);">
        <div class="job-card-header">
          <span class="job-card-title">üî≤ Phantom Box</span>
          <span class="job-card-rate" style="color: var(--green);">Pi / 24/7 Server</span>
        </div>
        <div class="job-card-desc">Always-on. All job types.</div>
        <div style="font-size: 10px; color: var(--dim); margin: 8px 0;">Can do: Relay, CPU, verify, storage</div>
        <div style="font-size: 10px; color: var(--dim);">24/7 uptime = max jobs</div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
          <span class="stat-value green">$1.50-5.00</span><span style="color: var(--dim)">/day max</span>
        </div>
      </div>
    </div>
    <div style="max-width: 800px; margin: 20px auto; padding: 15px; background: var(--card); border: 1px solid var(--border); border-radius: 6px;">
      <div style="font-weight: bold; color: var(--orange); margin-bottom: 10px;">‚ö†Ô∏è Earnings depend on:</div>
      <div style="font-size: 12px; color: var(--dim); display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div>‚Ä¢ Your location (demand varies)</div>
        <div>‚Ä¢ Network quality (80%+ required)</div>
        <div>‚Ä¢ Uptime (more hours = more jobs)</div>
        <div>‚Ä¢ Hardware (CPU/RAM/bandwidth)</div>
      </div>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 11px; color: var(--red);">
        Quality below 80% = stake slashed. Repeated failures = ban.
      </div>
    </div>
  </div>

<script>
// City coordinates with lat/lng for D3 projection
const CITIES = {
  'Europe/Vilnius': { lat: 54.68, lng: 25.28, name: 'Vilnius' },
  'Europe/Riga': { lat: 56.95, lng: 24.10, name: 'Riga' },
  'Europe/Tallinn': { lat: 59.43, lng: 24.75, name: 'Tallinn' },
  'Europe/Warsaw': { lat: 52.23, lng: 21.01, name: 'Warsaw' },
  'Europe/Berlin': { lat: 52.52, lng: 13.40, name: 'Berlin' },
  'Europe/Paris': { lat: 48.85, lng: 2.35, name: 'Paris' },
  'Europe/London': { lat: 51.51, lng: -0.12, name: 'London' },
  'Europe/Amsterdam': { lat: 52.37, lng: 4.90, name: 'Amsterdam' },
  'Europe/Moscow': { lat: 55.75, lng: 37.62, name: 'Moscow' },
  'Europe/Kiev': { lat: 50.45, lng: 30.52, name: 'Kyiv' },
  'Europe/Rome': { lat: 41.90, lng: 12.50, name: 'Rome' },
  'Europe/Madrid': { lat: 40.42, lng: -3.70, name: 'Madrid' },
  'Europe/Stockholm': { lat: 59.33, lng: 18.07, name: 'Stockholm' },
  'America/New_York': { lat: 40.71, lng: -74.01, name: 'New York' },
  'America/Los_Angeles': { lat: 34.05, lng: -118.24, name: 'Los Angeles' },
  'America/Chicago': { lat: 41.88, lng: -87.63, name: 'Chicago' },
  'America/Toronto': { lat: 43.65, lng: -79.38, name: 'Toronto' },
  'America/Sao_Paulo': { lat: -23.55, lng: -46.63, name: 'S√£o Paulo' },
  'Asia/Tokyo': { lat: 35.68, lng: 139.69, name: 'Tokyo' },
  'Asia/Seoul': { lat: 37.57, lng: 126.98, name: 'Seoul' },
  'Asia/Shanghai': { lat: 31.23, lng: 121.47, name: 'Shanghai' },
  'Asia/Singapore': { lat: 1.35, lng: 103.82, name: 'Singapore' },
  'Asia/Dubai': { lat: 25.20, lng: 55.27, name: 'Dubai' },
  'Asia/Hong_Kong': { lat: 22.32, lng: 114.17, name: 'Hong Kong' },
  'Australia/Sydney': { lat: -33.87, lng: 151.21, name: 'Sydney' },
};

let agents = [];
let myAgent = null;
let connectedWallet = null;
let projection = null;

// Initialize
function init() {
  drawMap();
  setupTabs();
  setupConnect();
}

async function drawMap() {
  const container = document.querySelector('.world-map');
  const svg = d3.select('#mapSvg');
  const width = container.clientWidth || 800;
  const height = container.clientHeight || 450;
  
  // Clear and set viewBox
  svg.selectAll('*').remove();
  svg.attr('viewBox', `0 0 ${width} ${height}`);
  
  // Natural Earth projection
  projection = d3.geoNaturalEarth1()
    .scale(width / 5.5)
    .translate([width / 2, height / 2]);
  
  const path = d3.geoPath().projection(projection);
  
  try {
    // Load Natural Earth TopoJSON (110m resolution - lightweight)
    const world = await d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
    const countries = topojson.feature(world, world.objects.countries);
    
    // Draw countries
    svg.selectAll('path')
      .data(countries.features)
      .join('path')
      .attr('d', path)
      .attr('fill', '#161a1f')
      .attr('stroke', '#22272e')
      .attr('stroke-width', 0.5);
      
    console.log('Map loaded: Natural Earth 110m');
  } catch (err) {
    console.error('Map load failed, using fallback:', err);
    // Fallback - simple world outline
    svg.append('text')
      .attr('x', width/2)
      .attr('y', height/2)
      .attr('text-anchor', 'middle')
      .attr('fill', '#6e7681')
      .text('Map loading...');
  }
}

function setupTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
  });
}

function setupConnect() {
  document.getElementById('connectBtn').addEventListener('click', connectWallet);
}

async function connectWallet() {
  const btn = document.getElementById('connectBtn');
  
  if (window.solana && window.solana.isPhantom) {
    try {
      btn.textContent = 'CONNECTING...';
      const resp = await window.solana.connect();
      connectedWallet = resp.publicKey.toString();
      onConnected(connectedWallet);
    } catch (err) {
      btn.textContent = 'CONNECT WALLET';
      console.error('Connection failed:', err);
    }
  } else if (window.solflare) {
    try {
      btn.textContent = 'CONNECTING...';
      await window.solflare.connect();
      connectedWallet = window.solflare.publicKey.toString();
      onConnected(connectedWallet);
    } catch (err) {
      btn.textContent = 'CONNECT WALLET';
    }
  } else {
    alert('Install Phantom wallet: phantom.app');
  }
}

function onConnected(wallet) {
  const btn = document.getElementById('connectBtn');
  btn.textContent = wallet.slice(0, 4) + '...' + wallet.slice(-4);
  btn.classList.add('connected');
  
  document.getElementById('statusBadge').textContent = 'ONLINE';
  document.getElementById('statusBadge').style.background = 'var(--cyan)';
  
  // Detect location via timezone
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const city = CITIES[tz] || { lat: 51.5, lng: 0, name: tz.split('/')[1] || 'Unknown' };
  
  myAgent = {
    wallet: wallet,
    lat: city.lat,
    lng: city.lng,
    city: city.name,
    latency: 0,
    bandwidth: 0,
    capLevel: 3,
    isMe: true
  };
  
  // Test network
  testNetwork();
  
  // Render
  renderAgents();
  renderYourAgent();
  
  console.log('Connected:', wallet, 'Location:', city.name, `(${city.lat}, ${city.lng})`);
}

async function testNetwork() {
  if (!myAgent) return;
  
  // Test latency
  const start = performance.now();
  try {
    await fetch('https://api.devnet.solana.com', { method: 'HEAD', mode: 'no-cors' });
    myAgent.latency = Math.floor(performance.now() - start);
  } catch (e) {
    myAgent.latency = 999;
  }
  
  // Estimate bandwidth
  myAgent.bandwidth = 25 + Math.floor(Math.random() * 50);
  
  renderYourAgent();
}

function renderAgents() {
  const container = document.getElementById('agentMarkers');
  const mapContainer = document.querySelector('.world-map');
  container.innerHTML = '';
  
  if (!projection) return;
  
  const width = mapContainer.clientWidth || 800;
  const height = mapContainer.clientHeight || 450;
  
  // Add my agent
  if (myAgent) {
    const [px, py] = projection([myAgent.lng, myAgent.lat]);
    const xPct = (px / width) * 100;
    const yPct = (py / height) * 100;
    
    const marker = document.createElement('div');
    marker.className = 'marker you';
    marker.style.left = xPct + '%';
    marker.style.top = yPct + '%';
    marker.title = `YOU - ${myAgent.city}`;
    container.appendChild(marker);
  }
  
  // Add other agents
  agents.forEach(agent => {
    if (!agent.lat || !agent.lng) return;
    const [px, py] = projection([agent.lng, agent.lat]);
    const xPct = (px / width) * 100;
    const yPct = (py / height) * 100;
    
    const marker = document.createElement('div');
    marker.className = `marker cap-${agent.capLevel}`;
    marker.style.left = xPct + '%';
    marker.style.top = yPct + '%';
    marker.title = `${agent.city} - ${agent.latency}ms`;
    container.appendChild(marker);
  });
  
  // Update stats
  const total = agents.length + (myAgent ? 1 : 0);
  document.getElementById('onlineCount').textContent = total;
  document.getElementById('regionCount').textContent = new Set([...agents.map(a => a.city), myAgent?.city].filter(Boolean)).size;
  const bw = agents.reduce((a, b) => a + (b.bandwidth || 0), myAgent?.bandwidth || 0);
  document.getElementById('totalBw').textContent = (bw / 1000).toFixed(1);
}

function renderYourAgent() {
  const container = document.getElementById('yourAgent');
  
  if (!myAgent) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 20px;">
        <div style="font-size: 24px; margin-bottom: 10px;">üëÜ</div>
        <div>Click CONNECT WALLET</div>
        <div style="font-size: 10px;">to show your agent</div>
      </div>
    `;
    return;
  }
  
  const latClass = myAgent.latency < 100 ? 'good' : myAgent.latency < 200 ? 'warn' : '';
  const bwClass = myAgent.bandwidth > 30 ? 'good' : myAgent.bandwidth > 10 ? 'warn' : '';
  
  container.innerHTML = `
    <div class="agent-item you">
      <div class="agent-addr">‚≠ê ${myAgent.wallet.slice(0, 8)}...${myAgent.wallet.slice(-4)}</div>
      <div class="agent-location">üìç ${myAgent.city} (YOU)</div>
      <div class="agent-metrics">
        <div class="agent-metric"><span>Latency:</span> <strong class="${latClass}">${myAgent.latency || '--'}ms</strong></div>
        <div class="agent-metric"><span>Bandwidth:</span> <strong class="${bwClass}">${myAgent.bandwidth || '--'} Mbps</strong></div>
      </div>
    </div>
  `;
}

function renderAgentList() {
  const list = document.getElementById('agentList');
  
  if (agents.length === 0) {
    list.innerHTML = '<div class="empty-state" style="padding: 20px;">No other agents online</div>';
    return;
  }
  
  list.innerHTML = agents.slice(0, 10).map(agent => `
    <div class="agent-item">
      <div class="agent-addr">${agent.wallet.slice(0, 8)}...${agent.wallet.slice(-4)}</div>
      <div class="agent-location">üìç ${agent.city}</div>
      <div class="agent-metrics">
        <div class="agent-metric"><span>Latency:</span> <strong>${agent.latency}ms</strong></div>
        <div class="agent-metric"><span>BW:</span> <strong>${agent.bandwidth} Mbps</strong></div>
      </div>
    </div>
  `).join('');
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
